import React from "react";
import {screen, waitFor} from "@testing-library/react";
import {renderWithProviders, gqlUtils} from "../../../../../framework/viz/charts/chart-test-utils";
import {ProjectFlowMetricsSettingWidget} from "./projectFlowMetricsSettingWidget";
import {GraphQLError} from "graphql";
import {PROJECT_CLOSED_DELIVERY_CYCLE_DETAIL} from "../../hooks/useQueryProjectClosedDeliveryCycleDetail";

const propsFixture = {
  instanceKey: "41af8b92-51f6-4e88-9765-cc3dbea35e1a",
  latestWorkItemEvent: "2020-12-09T22:31:01.244000", //TODO(need to see if this might cause time relative issue)
  days: 90,
  leadTimeTarget: 30,
  cycleTimeTarget: 7,
  leadTimeConfidenceTarget: 0.9,
  cycleTimeConfidenceTarget: 0.9,
  specsOnly: false,
};

const gqlRequest = {
  query: PROJECT_CLOSED_DELIVERY_CYCLE_DETAIL,
  variables: {
    key: "41af8b92-51f6-4e88-9765-cc3dbea35e1a",
    days: 90,
    specsOnly: false,
    referenceString: propsFixture.latestWorkItemEvent,
  },
};

const mocks = [
  {
    request: gqlRequest,
    result: {
      data: {
        project: {
          workItemDeliveryCycles: {
            edges: [
              {
                node: {
                  name: "Funnel closed does not match Flow Metrics Closed",
                  key: "5eb601cc-6a1d-483d-add7-417c321e7109:3588",
                  displayId: "PO-396",
                  workItemKey: "5eb601cc-6a1d-483d-add7-417c321e7109",
                  workItemType: "bug",
                  isBug: true,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-12-02T00:37:17.095000",
                  endDate: "2020-12-09T22:06:08.221000",
                  leadTime: 7.895034722222222,
                  cycleTime: 7.894618055555555,
                  latency: 0.026180555555555554,
                  effort: 1.16666666666667,
                  duration: 4.00299768518519,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Capacity trends widget does not filter out robots. ",
                  key: "f6e67348-c174-44a3-b4a4-058b9a967f9b:3603",
                  displayId: "PO-402",
                  workItemKey: "f6e67348-c174-44a3-b4a4-058b9a967f9b",
                  workItemType: "bug",
                  isBug: true,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-12-06T17:06:11.068000",
                  endDate: "2020-12-06T18:44:16.755000",
                  leadTime: 0.06811342592592592,
                  cycleTime: null,
                  latency: 0.052569444444444446,
                  effort: 0.333333333333333,
                  duration: 0,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Backfill Tests: EpicNodeRef and ImplementationCost interfaces for WorkItemDeliveryCycle Nodes",
                  key: "a18e5df6-70d0-4e5c-b02d-b5b09aafcf05:3534",
                  displayId: "PO-360",
                  workItemKey: "a18e5df6-70d0-4e5c-b02d-b5b09aafcf05",
                  workItemType: "task",
                  isBug: false,
                  state: "ROADMAP",
                  startDate: "2020-11-03T14:42:25.847000",
                  endDate: "2020-12-05T14:28:16.634000",
                  leadTime: 31.990162037037038,
                  cycleTime: 31.989745370370372,
                  latency: 0,
                  effort: null,
                  duration: null,
                  authorCount: null,
                },
              },
              {
                node: {
                  name: "Show unmapped states in WorkItemStateMapping GraphQL queries",
                  key: "23a42cd4-9004-4b66-818e-c5ecf38c65cc:3595",
                  displayId: "PO-400",
                  workItemKey: "23a42cd4-9004-4b66-818e-c5ecf38c65cc",
                  workItemType: "task",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-12-04T19:23:48.782000",
                  endDate: "2020-12-05T05:03:34.833000",
                  leadTime: 0.40261574074074075,
                  cycleTime: null,
                  latency: 0.06302083333333333,
                  effort: 1,
                  duration: 0.000486111111111111,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Refresh Open Pull Requests view when pull requests are updated. ",
                  key: "5bb46a5e-0dfd-41db-9dfc-b0e451aefd46:3590",
                  displayId: "PO-399",
                  workItemKey: "5bb46a5e-0dfd-41db-9dfc-b0e451aefd46",
                  workItemType: "story",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-12-03T22:18:11.793000",
                  endDate: "2020-12-05T03:42:01.684000",
                  leadTime: 1.2248842592592593,
                  cycleTime: 1.2246180555555557,
                  latency: 1.0530902777777778,
                  effort: 1,
                  duration: 0.135092592592593,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Add a GraphQL mutation to register webhooks on a repository connector",
                  key: "c4eb4a8f-e1a6-4667-8937-eb4f367fc0a5:3582",
                  displayId: "PO-390",
                  workItemKey: "c4eb4a8f-e1a6-4667-8937-eb4f367fc0a5",
                  workItemType: "task",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-11-24T21:30:37.892000",
                  endDate: "2020-12-03T19:31:17.641000",
                  leadTime: 8.91712962962963,
                  cycleTime: 8.345,
                  latency: null,
                  effort: 5.33333333333333,
                  duration: 11.1508333333333,
                  authorCount: 2,
                },
              },
              {
                node: {
                  name: "Code Review Time Trends Chart",
                  key: "415bddce-4c64-4abf-bcb0-73460c5dafc9:3591",
                  displayId: "PO-395",
                  workItemKey: "415bddce-4c64-4abf-bcb0-73460c5dafc9",
                  workItemType: "story",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-11-30T23:37:00.228000",
                  endDate: "2020-12-03T04:16:24.988000",
                  leadTime: 2.1940393518518517,
                  cycleTime: null,
                  latency: 0.24116898148148147,
                  effort: 0.333333333333333,
                  duration: 0.0443171296296296,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Code Reviews Completed Trend Chart",
                  key: "033a700e-5ed7-4992-9141-5f178383ca22:3592",
                  displayId: "PO-393",
                  workItemKey: "033a700e-5ed7-4992-9141-5f178383ca22",
                  workItemType: "story",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-11-30T00:41:05.937000",
                  endDate: "2020-12-03T04:16:19.928000",
                  leadTime: 3.149467592592593,
                  cycleTime: null,
                  latency: 0.40784722222222225,
                  effort: 0.333333333333333,
                  duration: 0.0113310185185185,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Column chart for Wip Effort",
                  key: "85ba52fd-05d5-4ce1-9d6c-82384cb4fa09:3584",
                  displayId: "PO-388",
                  workItemKey: "85ba52fd-05d5-4ce1-9d6c-82384cb4fa09",
                  workItemType: "story",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-11-23T16:08:36.135000",
                  endDate: "2020-12-02T08:20:57.774000",
                  leadTime: 8.67525462962963,
                  cycleTime: 4.385034722222223,
                  latency: null,
                  effort: 2.33333333333333,
                  duration: 4.80559027777778,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name:
                    "Add Troubleshooting steps for node-gyp error while doing yarn install in Polaris-analytics-web repo",
                  key: "f4731dba-6ae0-40a1-9d99-be9097b95310:3594",
                  displayId: "PO-394",
                  workItemKey: "f4731dba-6ae0-40a1-9d99-be9097b95310",
                  workItemType: "task",
                  isBug: false,
                  state: "Done",
                  startDate: "2020-11-30T13:01:01.872000",
                  endDate: "2020-11-30T16:33:56.571000",
                  leadTime: 0.1478587962962963,
                  cycleTime: null,
                  latency: 0.0025462962962962965,
                  effort: 0.5,
                  duration: 0,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Setup web tests in CI environment",
                  key: "9eb7d2cb-05a0-406c-b66d-3c289766abf1:3581",
                  displayId: "PO-391",
                  workItemKey: "9eb7d2cb-05a0-406c-b66d-3c289766abf1",
                  workItemType: "task",
                  isBug: false,
                  state: "Done",
                  startDate: "2020-11-28T04:11:00.554000",
                  endDate: "2020-11-29T16:21:18.853000",
                  leadTime: 1.5071527777777778,
                  cycleTime: null,
                  latency: 0.0002777777777777778,
                  effort: 2,
                  duration: 0.570034722222222,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Setup Cypress for E2E Testing",
                  key: "b7cd1ea3-2b2f-481a-a232-a7cf83ee24cd:3586",
                  displayId: "PO-387",
                  workItemKey: "b7cd1ea3-2b2f-481a-a232-a7cf83ee24cd",
                  workItemType: "task",
                  isBug: false,
                  state: "Done",
                  startDate: "2020-11-23T08:58:27.857000",
                  endDate: "2020-11-26T21:18:24.026000",
                  leadTime: 3.5138425925925927,
                  cycleTime: null,
                  latency: 0.01704861111111111,
                  effort: 0.5,
                  duration: 0.0159722222222222,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Setting up testing with jest and testing-library/react",
                  key: "e714b4af-64f5-4b30-a888-1345fac90a09:3568",
                  displayId: "PO-382",
                  workItemKey: "e714b4af-64f5-4b30-a888-1345fac90a09",
                  workItemType: "task",
                  isBug: false,
                  state: "Done",
                  startDate: "2020-11-20T16:15:45.801000",
                  endDate: "2020-11-26T20:42:08.169000",
                  leadTime: 6.184976851851852,
                  cycleTime: 6.184398148148148,
                  latency: 0.14325231481481482,
                  effort: 4,
                  duration: 6.03018518518518,
                  authorCount: 2,
                },
              },
              {
                node: {
                  name: "Potential discrepancy in showing % At Target for Cycle Time",
                  key: "754a72fa-5e24-4966-a805-4c9a16fcce94:3546",
                  displayId: "PO-349",
                  workItemKey: "754a72fa-5e24-4966-a805-4c9a16fcce94",
                  workItemType: "bug",
                  isBug: true,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-10-27T19:49:09.191000",
                  endDate: "2020-11-26T17:10:19.065000",
                  leadTime: 29.889699074074073,
                  cycleTime: 29.65310185185185,
                  latency: 3.820451388888889,
                  effort: 0.333333333333333,
                  duration: 0.0488541666666667,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Open Pull Requests Summary View on Wip board.",
                  key: "685766ff-1e4b-45d6-bca8-d45605790eb1:3567",
                  displayId: "PO-385",
                  workItemKey: "685766ff-1e4b-45d6-bca8-d45605790eb1",
                  workItemType: "story",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-11-21T22:33:17.709000",
                  endDate: "2020-11-26T17:10:19.017000",
                  leadTime: 4.775706018518519,
                  cycleTime: 4.774988425925926,
                  latency: 4.551030092592592,
                  effort: 0.666666666666667,
                  duration: 0.201689814814815,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Implement Pull Request Webhooks for Gitlab",
                  key: "8ae253d4-d3c0-42a2-badc-22a96f1961e1:3574",
                  displayId: "PO-377",
                  workItemKey: "8ae253d4-d3c0-42a2-badc-22a96f1961e1",
                  workItemType: "task",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-11-18T16:18:37.154000",
                  endDate: "2020-11-25T22:44:17.124000",
                  leadTime: 7.267824074074074,
                  cycleTime: 5.005520833333334,
                  latency: 0.0855324074074074,
                  effort: 2,
                  duration: 6.20228009259259,
                  authorCount: 2,
                },
              },
              {
                node: {
                  name: "UX TWeaks",
                  key: "d2713f83-557d-4a16-bba5-0842a064fdd9:3579",
                  displayId: "PO-384",
                  workItemKey: "d2713f83-557d-4a16-bba5-0842a064fdd9",
                  workItemType: "story",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-11-21T20:43:21.292000",
                  endDate: "2020-11-22T22:33:15.344000",
                  leadTime: 1.0763194444444444,
                  cycleTime: 1.0005902777777778,
                  latency: 1.0009027777777777,
                  effort: 0.333333333333333,
                  duration: 0.059224537037037,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Small UX Tweaks",
                  key: "519eaf2b-18c3-4070-97c3-9f568c4d3304:3583",
                  displayId: "PO-386",
                  workItemKey: "519eaf2b-18c3-4070-97c3-9f568c4d3304",
                  workItemType: "story",
                  isBug: false,
                  state: "DEPLOYED-TO-STAGING",
                  startDate: "2020-11-22T21:38:49.220000",
                  endDate: "2020-11-22T22:31:31.916000",
                  leadTime: 0.0366087962962963,
                  cycleTime: null,
                  latency: 0.017534722222222222,
                  effort: 0.333333333333333,
                  duration: 0.00864583333333333,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Bitbucket webURLs map apiUrls instead. ",
                  key: "61744002-daea-4833-9425-dc381bdbc12b:3576",
                  displayId: "PO-383",
                  workItemKey: "61744002-daea-4833-9425-dc381bdbc12b",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-11-20T23:04:46.958000",
                  endDate: "2020-11-21T17:50:51.151000",
                  leadTime: 0.7819907407407407,
                  cycleTime: null,
                  latency: 0.023449074074074074,
                  effort: 0.333333333333333,
                  duration: 0.000555555555555556,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Adding support for prettier",
                  key: "dc10a6a5-d5ef-432f-9cbd-d4cbe79e556e:3572",
                  displayId: "PO-381",
                  workItemKey: "dc10a6a5-d5ef-432f-9cbd-d4cbe79e556e",
                  workItemType: "task",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-19T10:55:21.528000",
                  endDate: "2020-11-21T17:50:43.427000",
                  leadTime: 2.288449074074074,
                  cycleTime: null,
                  latency: 1.7726967592592593,
                  effort: 0.333333333333333,
                  duration: 0,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Specs/all control displays on top commit tooltip in pipeline view. ",
                  key: "87ec76f2-79e8-45e2-90bd-1fdc4ee9d0e2:3578",
                  displayId: "PO-376",
                  workItemKey: "87ec76f2-79e8-45e2-90bd-1fdc4ee9d0e2",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-11-18T16:14:57.006000",
                  endDate: "2020-11-21T17:50:35.230000",
                  leadTime: 3.066412037037037,
                  cycleTime: null,
                  latency: 3.0652430555555554,
                  effort: 1,
                  duration: 0,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Update Pull Request Sync Logic in Connectors",
                  key: "7352ad09-422b-4873-bf50-631aa18c2f12:3569",
                  displayId: "PO-375",
                  workItemKey: "7352ad09-422b-4873-bf50-631aa18c2f12",
                  workItemType: "task",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-18T00:08:00.795000",
                  endDate: "2020-11-21T17:50:27.670000",
                  leadTime: 3.7378125,
                  cycleTime: null,
                  latency: 1.720960648148148,
                  effort: 1.33333333333333,
                  duration: 0.505891203703704,
                  authorCount: 2,
                },
              },
              {
                node: {
                  name: "Tutorial for Polaris Front End Development Basics",
                  key: "3bd43d6f-39ee-4adc-935b-932a14498997:3570",
                  displayId: "PO-374",
                  workItemKey: "3bd43d6f-39ee-4adc-935b-932a14498997",
                  workItemType: "task",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-17T03:17:54.652000",
                  endDate: "2020-11-21T17:50:20.700000",
                  leadTime: 4.6058564814814815,
                  cycleTime: null,
                  latency: 4.164988425925926,
                  effort: 1,
                  duration: 0.367638888888889,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Setup for front end tutorials. ",
                  key: "d4490d93-a9a1-4244-8f21-ea0aa9db012b:3580",
                  displayId: "PO-373",
                  workItemKey: "d4490d93-a9a1-4244-8f21-ea0aa9db012b",
                  workItemType: "task",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-15T17:52:22.579000",
                  endDate: "2020-11-21T17:50:13.664000",
                  leadTime: 5.998506944444444,
                  cycleTime: null,
                  latency: 4.048240740740741,
                  effort: 2,
                  duration: 1.72497685185185,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Move pipeline dashboard to default to smaller measurementWindow than Flow dashboard",
                  key: "0a82ce01-9461-41ba-aaa0-831b55ea90c0:3573",
                  displayId: "PO-372",
                  workItemKey: "0a82ce01-9461-41ba-aaa0-831b55ea90c0",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-14T18:55:05.157000",
                  endDate: "2020-11-21T17:50:03.674000",
                  leadTime: 6.954849537037037,
                  cycleTime: null,
                  latency: 5.116342592592592,
                  effort: 1.33333333333333,
                  duration: 1.836875,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Implement data model and GraphQL Api for AzureDevOps Connector",
                  key: "a350bad4-4af2-4702-ad17-b6ca683f7496:3565",
                  displayId: "PO-367",
                  workItemKey: "a350bad4-4af2-4702-ad17-b6ca683f7496",
                  workItemType: "task",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-11T21:38:27.411000",
                  endDate: "2020-11-21T17:49:39.427000",
                  leadTime: 9.841111111111111,
                  cycleTime: 8.899826388888888,
                  latency: 8.902777777777779,
                  effort: 0.5,
                  duration: 0.000590277777777778,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Show Pull Requests on Work Item Timeline",
                  key: "e722f3e9-a824-424e-b01a-5c26214270e0:3512",
                  displayId: "PO-321",
                  workItemKey: "e722f3e9-a824-424e-b01a-5c26214270e0",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-09-29T22:59:11.845000",
                  endDate: "2020-11-21T17:48:14.550000",
                  leadTime: 52.7840625,
                  cycleTime: null,
                  latency: 0.8041550925925925,
                  effort: 0.833333333333333,
                  duration: 1.02086805555556,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Github weburl links launch the api endpoint instead of the web endpoint",
                  key: "a758cd47-567f-486f-8f81-0ba307cdd30a:3564",
                  displayId: "PO-371",
                  workItemKey: "a758cd47-567f-486f-8f81-0ba307cdd30a",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-11-14T01:26:25.254000",
                  endDate: "2020-11-14T14:33:47.791000",
                  leadTime: 0.5467939814814815,
                  cycleTime: null,
                  latency: 0.019363425925925926,
                  effort: 0.333333333333333,
                  duration: 0.00136574074074074,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Implement a GraphQL interface to return WorkItemSummaries for a PullRequest",
                  key: "1f460527-544b-419f-95c1-99c65d87252e:3558",
                  displayId: "PO-365",
                  workItemKey: "1f460527-544b-419f-95c1-99c65d87252e",
                  workItemType: "task",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-10T01:42:59.955000",
                  endDate: "2020-11-14T03:24:11.510000",
                  leadTime: 4.070277777777778,
                  cycleTime: 4.067731481481482,
                  latency: 2.386863425925926,
                  effort: 0.5,
                  duration: 0.00491898148148148,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Show Open PRs on Pipeline dashboard",
                  key: "347222a7-618a-43a4-87ea-df8483402b3f:3562",
                  displayId: "PO-370",
                  workItemKey: "347222a7-618a-43a4-87ea-df8483402b3f",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-12T22:07:25.766000",
                  endDate: "2020-11-14T03:19:21.799000",
                  leadTime: 1.2166203703703704,
                  cycleTime: null,
                  latency: 0.02445601851851852,
                  effort: 1.33333333333333,
                  duration: 0.239768518518519,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Edit Readme file for any setup related corrections",
                  key: "3e7e877c-c820-4579-a17f-d7a473e98f92:3566",
                  displayId: "PO-368",
                  workItemKey: "3e7e877c-c820-4579-a17f-d7a473e98f92",
                  workItemType: "task",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-12T05:39:36.443000",
                  endDate: "2020-11-12T07:00:50.821000",
                  leadTime: 0.05641203703703704,
                  cycleTime: null,
                  latency: 0.009016203703703703,
                  effort: 1,
                  duration: 0,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Implement Pull Request Connection on Projects",
                  key: "58199159-965b-4170-8ab2-dc50fff5a3ae:3559",
                  displayId: "PO-364",
                  workItemKey: "58199159-965b-4170-8ab2-dc50fff5a3ae",
                  workItemType: "task",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-10T01:37:51.069000",
                  endDate: "2020-11-11T22:53:17.617000",
                  leadTime: 1.8857291666666667,
                  cycleTime: 1.4958333333333333,
                  latency: 0.21121527777777777,
                  effort: 1.5,
                  duration: 1.31167824074074,
                  authorCount: 2,
                },
              },
              {
                node: {
                  name: "Show Pull Requests on Work Item Timeline",
                  key: "65e015fa-4b92-4556-b0fb-9f25711036c9:3535",
                  displayId: "PO-357",
                  workItemKey: "65e015fa-4b92-4556-b0fb-9f25711036c9",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-01T22:26:23.731000",
                  endDate: "2020-11-11T18:06:33.498000",
                  leadTime: 9.819560185185185,
                  cycleTime: 8.74175925925926,
                  latency: 0.7648495370370371,
                  effort: 5,
                  duration: 7.38730324074074,
                  authorCount: 2,
                },
              },
              {
                node: {
                  name: "Wip Epic shows greater totals than total effort in Wip flow metrics tab.",
                  key: "7bcef101-a6d2-43b8-a910-9e8d5849b22d:3560",
                  displayId: "PO-362",
                  workItemKey: "7bcef101-a6d2-43b8-a910-9e8d5849b22d",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-11-05T16:38:08.327000",
                  endDate: "2020-11-10T01:25:33.737000",
                  leadTime: 4.366261574074074,
                  cycleTime: null,
                  latency: null,
                  effort: null,
                  duration: null,
                  authorCount: null,
                },
              },
              {
                node: {
                  name:
                    "Spec counts are inconsistent between flow metrics and funnel, and also between flow metrics summary and detail",
                  key: "ad6eb741-ba6f-4d4b-b517-d8393b4ac73e:3557",
                  displayId: "PO-363",
                  workItemKey: "ad6eb741-ba6f-4d4b-b517-d8393b4ac73e",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-11-06T17:42:56.510000",
                  endDate: "2020-11-10T01:21:52.960000",
                  leadTime: 3.3187037037037035,
                  cycleTime: null,
                  latency: 0.0757638888888889,
                  effort: 1,
                  duration: 0.0215972222222222,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Show effort instead of Volume on Funnel when specsOnly is chosen",
                  key: "699da7db-0252-49cf-81be-ca8110f4877c:3547",
                  displayId: "PO-359",
                  workItemKey: "699da7db-0252-49cf-81be-ca8110f4877c",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-03T00:19:24.531000",
                  endDate: "2020-11-07T14:21:52.361000",
                  leadTime: 4.585046296296296,
                  cycleTime: 4.585046296296296,
                  latency: 0.6955324074074074,
                  effort: 2,
                  duration: 1.1344212962963,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Commit history chart bails for long histories",
                  key: "060abd1c-15ba-4196-8898-1cf01b537a85:3542",
                  displayId: "PO-361",
                  workItemKey: "060abd1c-15ba-4196-8898-1cf01b537a85",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-11-03T20:24:02.743000",
                  endDate: "2020-11-05T16:42:22.562000",
                  leadTime: 1.8460648148148149,
                  cycleTime: 1.8459837962962964,
                  latency: 1.844050925925926,
                  effort: 0.5,
                  duration: 0,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "UX updates",
                  key: "e7641014-86a7-45ea-8e67-084f16763205:3549",
                  displayId: "PO-358",
                  workItemKey: "e7641014-86a7-45ea-8e67-084f16763205",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-11-03T00:15:56.586000",
                  endDate: "2020-11-03T19:14:49.505000",
                  leadTime: 0.7908912037037037,
                  cycleTime: null,
                  latency: 0.04121527777777778,
                  effort: 1,
                  duration: 0.651875,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Totals dont match between flow metrics and epic flow mix",
                  key: "58878021-6623-4fcc-96b3-cf8cf0a8272f:3537",
                  displayId: "PO-353",
                  workItemKey: "58878021-6623-4fcc-96b3-cf8cf0a8272f",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-10-30T01:45:42.840000",
                  endDate: "2020-11-03T19:14:41.053000",
                  leadTime: 4.728449074074074,
                  cycleTime: null,
                  latency: 0.8232407407407407,
                  effort: 0.75,
                  duration: 0.855949074074074,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Pipeline Pull Request Metrics returns incorrect results. ",
                  key: "cfc9f9d3-3e42-4aaf-afd3-3ad710a95318:3538",
                  displayId: "PO-350",
                  workItemKey: "cfc9f9d3-3e42-4aaf-afd3-3ad710a95318",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-10-27T23:27:42.525000",
                  endDate: "2020-11-01T23:19:28.338000",
                  leadTime: 4.9942824074074075,
                  cycleTime: null,
                  latency: 0.049525462962962966,
                  effort: 0.25,
                  duration: 0,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Pull Request Connection Infrastructure",
                  key: "3125da71-132c-477a-ba3f-677a82f63173:3499",
                  displayId: "PO-320",
                  workItemKey: "3125da71-132c-477a-ba3f-677a82f63173",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-09-29T22:49:07.335000",
                  endDate: "2020-11-01T23:19:24.851000",
                  leadTime: 33.02104166666667,
                  cycleTime: null,
                  latency: 0.018368055555555554,
                  effort: 1.25,
                  duration: 4.43787037037037,
                  authorCount: 2,
                },
              },
              {
                node: {
                  name: "UX Tweaks",
                  key: "e7f72af2-7cc6-47b1-846b-cd5fef01248c:3545",
                  displayId: "PO-356",
                  workItemKey: "e7f72af2-7cc6-47b1-846b-cd5fef01248c",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-31T16:00:02.705000",
                  endDate: "2020-11-01T22:22:53.207000",
                  leadTime: 1.2658680555555557,
                  cycleTime: null,
                  latency: 0.851087962962963,
                  effort: 1.25,
                  duration: 0.414224537037037,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Capcacity Summary Widget on Value Board tends to overflow the widget box. ",
                  key: "d6a7a052-76c3-4eea-905f-0a509f77ecf2:3532",
                  displayId: "PO-355",
                  workItemKey: "d6a7a052-76c3-4eea-905f-0a509f77ecf2",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-10-30T02:19:15.241000",
                  endDate: "2020-10-31T00:31:04.370000",
                  leadTime: 0.9248726851851852,
                  cycleTime: null,
                  latency: 0.2883449074074074,
                  effort: 0.333333333333333,
                  duration: 0.0668055555555556,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Effort Flow Mix Widget Bugs",
                  key: "3af2d2ea-d0a6-44ad-af2d-cdecaf135f26:3553",
                  displayId: "PO-354",
                  workItemKey: "3af2d2ea-d0a6-44ad-af2d-cdecaf135f26",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-10-30T02:12:55.418000",
                  endDate: "2020-10-30T14:46:50.663000",
                  leadTime: 0.5235532407407407,
                  cycleTime: null,
                  latency: 0.06244212962962963,
                  effort: 0.666666666666667,
                  duration: 0.44744212962963,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Show Epic level rollup of Effort for pipeline and closed work items in value board. ",
                  key: "1801bd26-ad40-485f-9c66-08089c00303c:3543",
                  displayId: "PO-351",
                  workItemKey: "1801bd26-ad40-485f-9c66-08089c00303c",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-28T17:38:12.217000",
                  endDate: "2020-10-30T11:33:05.235000",
                  leadTime: 1.7464467592592594,
                  cycleTime: null,
                  latency: 0.5020949074074074,
                  effort: 0.333333333333333,
                  duration: 0.0522569444444444,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Update FlowMetrics Summary in Value Board",
                  key: "538537b7-8aaf-42c9-9561-0d892d009c89:3541",
                  displayId: "PO-352",
                  workItemKey: "538537b7-8aaf-42c9-9561-0d892d009c89",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-29T23:31:42.646000",
                  endDate: "2020-10-30T02:20:09.092000",
                  leadTime: 0.1169675925925926,
                  cycleTime: null,
                  latency: 0.029583333333333333,
                  effort: 0.666666666666667,
                  duration: 0.0102314814814815,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Show Pull Request Metrics Trends for Project",
                  key: "57226a89-421e-47a7-9c3b-5615f798ea51:3501",
                  displayId: "PO-319",
                  workItemKey: "57226a89-421e-47a7-9c3b-5615f798ea51",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-09-29T22:12:27.457000",
                  endDate: "2020-10-28T13:30:48.013000",
                  leadTime: 28.637743055555557,
                  cycleTime: null,
                  latency: 0.6824768518518518,
                  effort: 1.5,
                  duration: 4.36293981481481,
                  authorCount: 2,
                },
              },
              {
                node: {
                  name: "Show Pull Request Metrics for current pipeline",
                  key: "53acef58-bc34-40da-9964-8e7ccae38f35:3500",
                  displayId: "PO-318",
                  workItemKey: "53acef58-bc34-40da-9964-8e7ccae38f35",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-09-29T21:45:39.003000",
                  endDate: "2020-10-28T13:30:47.266000",
                  leadTime: 28.656342592592594,
                  cycleTime: 15.876712962962962,
                  latency: 5.045405092592593,
                  effort: 8,
                  duration: 14.9446064814815,
                  authorCount: 2,
                },
              },
              {
                node: {
                  name: "Work Item Implementation Cost Chart",
                  key: "6b11da16-ed0b-4ed8-a0e0-dd79a6c618e0:3548",
                  displayId: "PO-348",
                  workItemKey: "6b11da16-ed0b-4ed8-a0e0-dd79a6c618e0",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-26T11:37:43.827000",
                  endDate: "2020-10-26T23:08:43.181000",
                  leadTime: 0.47984953703703703,
                  cycleTime: null,
                  latency: 0.023958333333333335,
                  effort: 1,
                  duration: 0.364710648148148,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Streamline pipeline summary and performance metrics in the new FlowBoard",
                  key: "b7219c78-650d-4a87-a33b-ac79906799d8:3551",
                  displayId: "PO-347",
                  workItemKey: "b7219c78-650d-4a87-a33b-ac79906799d8",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-24T21:32:48.510000",
                  endDate: "2020-10-26T23:08:35.336000",
                  leadTime: 2.0665162037037037,
                  cycleTime: null,
                  latency: 1.0711805555555556,
                  effort: 0.5,
                  duration: 0.374652777777778,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Setup ValueBoard Scaffolding",
                  key: "89cfce9a-aab8-4e09-b6f9-44a4e42f8536:3550",
                  displayId: "PO-346",
                  workItemKey: "89cfce9a-aab8-4e09-b6f9-44a4e42f8536",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-23T16:17:13.985000",
                  endDate: "2020-10-26T23:08:23.576000",
                  leadTime: 3.2855324074074073,
                  cycleTime: null,
                  latency: 2.1220717592592595,
                  effort: 1.5,
                  duration: 1.14949074074074,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Show Cadence metrics",
                  key: "babb4899-882d-4d37-b841-9424c6b8655e:3552",
                  displayId: "PO-340",
                  workItemKey: "babb4899-882d-4d37-b841-9424c6b8655e",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-19T14:20:56.737000",
                  endDate: "2020-10-26T23:08:15.412000",
                  leadTime: 7.3661921296296295,
                  cycleTime: null,
                  latency: 0.9874189814814814,
                  effort: 0.5,
                  duration: 0.00450231481481481,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Update cycle time latency chart to use logarithmic xaxis",
                  key: "8fd1c4e6-21ab-4a9b-9e46-58c690e406f9:3554",
                  displayId: "PO-344",
                  workItemKey: "8fd1c4e6-21ab-4a9b-9e46-58c690e406f9",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-22T14:23:23.374000",
                  endDate: "2020-10-23T15:58:07.374000",
                  leadTime: 1.065787037037037,
                  cycleTime: null,
                  latency: null,
                  effort: null,
                  duration: null,
                  authorCount: null,
                },
              },
              {
                node: {
                  name: "When there are no work items in engineering or delivery latency chart shows a blank screen",
                  key: "1c3aea0e-ffd7-4e49-b24b-01486265345e:3540",
                  displayId: "PO-343",
                  workItemKey: "1c3aea0e-ffd7-4e49-b24b-01486265345e",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-10-21T21:17:50.953000",
                  endDate: "2020-10-23T15:57:52.315000",
                  leadTime: 1.777789351851852,
                  cycleTime: null,
                  latency: 1.7763425925925926,
                  effort: 0.5,
                  duration: 0,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Show work item state on commit timeline",
                  key: "3d3aae5a-c4d6-493f-ada5-468fc4de833e:3536",
                  displayId: "PO-339",
                  workItemKey: "3d3aae5a-c4d6-493f-ada5-468fc4de833e",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-19T14:15:44.825000",
                  endDate: "2020-10-23T15:57:36.690000",
                  leadTime: 4.0707407407407405,
                  cycleTime: null,
                  latency: 0.13798611111111111,
                  effort: 0.5,
                  duration: 0.0394560185185185,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "CycleTimeLatencyWidget not updating when a new commit comes in. ",
                  key: "c63f0eef-4618-4a6e-a687-ac19f1826780:3544",
                  displayId: "PO-338",
                  workItemKey: "c63f0eef-4618-4a6e-a687-ac19f1826780",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-10-18T22:34:35.045000",
                  endDate: "2020-10-23T15:57:18.273000",
                  leadTime: 4.724108796296297,
                  cycleTime: null,
                  latency: 3.6206134259259257,
                  effort: 1,
                  duration: 0.00778935185185185,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Contributor Count discrepancy between master and detail view of Capacity Trends. ",
                  key: "caa0ea3a-6fa0-4f48-9759-45c588ba7450:3533",
                  displayId: "PO-337",
                  workItemKey: "caa0ea3a-6fa0-4f48-9759-45c588ba7450",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-10-18T20:52:17.139000",
                  endDate: "2020-10-23T15:57:10.097000",
                  leadTime: 4.79505787037037,
                  cycleTime: null,
                  latency: 2.811898148148148,
                  effort: 1.25,
                  duration: 1.93258101851852,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Flow Metrics Detail Enhancements",
                  key: "bc266c9d-ecfe-4987-9a7b-2c5dad8f7227:3531",
                  displayId: "PO-336",
                  workItemKey: "bc266c9d-ecfe-4987-9a7b-2c5dad8f7227",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-18T15:25:46.866000",
                  endDate: "2020-10-23T15:56:47.027000",
                  leadTime: 5.021527777777778,
                  cycleTime: 4.951134259259259,
                  latency: 4.975416666666667,
                  effort: 0.25,
                  duration: 0.0453125,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Classic flowboard enhancements",
                  key: "5b020109-6eac-4a31-bd2e-5829a0ff94a2:3530",
                  displayId: "PO-335",
                  workItemKey: "5b020109-6eac-4a31-bd2e-5829a0ff94a2",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-17T20:03:37.709000",
                  endDate: "2020-10-23T15:56:36.557000",
                  leadTime: 5.828460648148148,
                  cycleTime: 4.950960648148148,
                  latency: 5.023020833333334,
                  effort: 0.75,
                  duration: 0.770300925925926,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Cycle Time vs Latency Widget for Current Pipeline",
                  key: "1435793a-5a90-4841-a1aa-c73cbf6763b7:3526",
                  displayId: "PO-334",
                  workItemKey: "1435793a-5a90-4841-a1aa-c73cbf6763b7",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-15T15:41:47.042000",
                  endDate: "2020-10-23T15:55:53.236000",
                  leadTime: 8.009791666666667,
                  cycleTime: 8.009502314814815,
                  latency: 4.9395138888888885,
                  effort: 2.75,
                  duration: 3.03385416666667,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Backfill tests for CapacityTrends GraphQL Query",
                  key: "5d4c632d-a383-4c50-ba83-4e1ebe71994f:3529",
                  displayId: "PO-333",
                  workItemKey: "5d4c632d-a383-4c50-ba83-4e1ebe71994f",
                  workItemType: "task",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-10-15T15:30:59.654000",
                  endDate: "2020-10-23T15:55:41.101000",
                  leadTime: 8.017141203703703,
                  cycleTime: 8.016134259259259,
                  latency: 0.8370601851851852,
                  effort: 0.333333333333333,
                  duration: 0.000532407407407407,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Cycle time and total times in work item by phase chart is wrong",
                  key: "922cfed5-f8b3-44a3-947b-b961c76efa03:3555",
                  displayId: "PO-341",
                  workItemKey: "922cfed5-f8b3-44a3-947b-b961c76efa03",
                  workItemType: "bug",
                  isBug: true,
                  state: "Closed",
                  startDate: "2020-10-19T18:38:16.288000",
                  endDate: "2020-10-23T15:55:15.117000",
                  leadTime: 3.8867939814814814,
                  cycleTime: null,
                  latency: 0.736550925925926,
                  effort: 0.333333333333333,
                  duration: 0,
                  authorCount: 1,
                },
              },
              {
                node: {
                  name: "Show Commit Days Trends on Trends Dashboard",
                  key: "0f1fe144-31e8-4927-a029-087891b15360:3515",
                  displayId: "PO-316",
                  workItemKey: "0f1fe144-31e8-4927-a029-087891b15360",
                  workItemType: "story",
                  isBug: false,
                  state: "Closed",
                  startDate: "2020-09-29T15:17:23.056000",
                  endDate: "2020-10-23T15:49:36.969000",
                  leadTime: 24.02238425925926,
                  cycleTime: null,
                  latency: null,
                  effort: null,
                  duration: null,
                  authorCount: null,
                },
              },
            ],
          },
        },
      },
    },
  },
];

describe("ProjectFlowMetricsSettingWidget", () => {
  describe("should render the widget without any error", () => {
    test("renders without any error", async () => {
      renderWithProviders(<ProjectFlowMetricsSettingWidget {...propsFixture} />, mocks);
      expect(await screen.findByTestId("flowmetrics-setting-view")).toBeInTheDocument();
    });

    test("it shows loading spinner", () => {
      renderWithProviders(<ProjectFlowMetricsSettingWidget {...propsFixture} />, mocks);
      expect(screen.queryByTestId("loading-spinner")).toBeInTheDocument();
    });
  });

  describe("when there are errors", () => {
    let logGraphQlError;
    beforeEach(() => {
      logGraphQlError = jest.spyOn(gqlUtils, "logGraphQlError").mockImplementation(() => {});
    });
    afterEach(() => {
      logGraphQlError.mockRestore();
    });

    const mockNetworkError = [
      {
        request: gqlRequest,
        error: new Error("A network error Occurred"),
      },
    ];

    const mockGraphQlErrors = [
      {
        request: gqlRequest,
        result: {
          errors: [new GraphQLError("A GraphQL Error Occurred")],
        },
      },
    ];

    test("it renders nothing and logs the error when there is a network error", async () => {
      renderWithProviders(<ProjectFlowMetricsSettingWidget {...propsFixture} />, mockNetworkError);
      await screen.findByTestId("loading-spinner");
      await waitFor(() => expect(logGraphQlError).toHaveBeenCalled());
      expect(await screen.queryByTestId("flowmetrics-setting-view")).not.toBeInTheDocument();
    });

    test("it renders nothing and logs the error when there is a GraphQl error", async () => {
      renderWithProviders(<ProjectFlowMetricsSettingWidget {...propsFixture} />, mockGraphQlErrors);
      await screen.findByTestId("loading-spinner");
      await waitFor(() => expect(logGraphQlError).toHaveBeenCalled());
      expect(await screen.queryByTestId("flowmetrics-setting-view")).not.toBeInTheDocument();
    });
  });

  describe("when there are no workItems", () => {
    const emptyMocksFixture = [
      {
        request: gqlRequest,
        result: {
          data: {
            project: {
              workItemDeliveryCycles: {
                edges: [],
              },
            },
          },
        },
      },
    ];

    test("it renders both target and confidence sliders", async () => {
      renderWithProviders(<ProjectFlowMetricsSettingWidget {...propsFixture} />, emptyMocksFixture);
      await screen.findByTestId("target-range-slider");
      await screen.findByTestId("confidence-range-slider");
    });

    test("renders appropriate message on the chart title when there are no workItems", async () => {
      renderWithProviders(<ProjectFlowMetricsSettingWidget {...propsFixture} />, emptyMocksFixture);
      await screen.findByText(/0 work items closed/i);
    });
  });

  describe("when there are workItems", () => {
    test("it renders both target and confidence sliders", async () => {
      renderWithProviders(<ProjectFlowMetricsSettingWidget {...propsFixture} />, mocks);
      await screen.findByTestId("target-range-slider");
      await screen.findByTestId("confidence-range-slider");
    });

    // this ensures when widget is rendered its able to render till chart component(tests integration of widget view and chart)
    test("it renders chart", async () => {
      renderWithProviders(<ProjectFlowMetricsSettingWidget {...propsFixture} />, mocks, {
        chartTestId: "project-flowmetrics-chart",
      });
      await screen.findByTestId("project-flowmetrics-chart");
    });
  });
});
